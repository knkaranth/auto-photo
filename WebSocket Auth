// ==UserScript==
// @name         SmartLock WebSocket Auth
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  WebSocket authentication handler (exact logic preserved)
// @match        https://sarathi.parivahan.gov.in/sarathiservice/*
// @grant        none
// @run-at       document-end
// ==/UserScript==

(function () {
    'use strict';

    // Global variables (as in original code)
    window.socket = null;
    window.serverToken = null;

    // ============================
    // create_hs FUNCTION
    // ============================
    window.create_hs = function (appl_no, authType) {

        var smartDiv = document.getElementById('smartLock');
        var faceAuth = document.getElementById('faceAuthReq');
        var proctorReq = document.getElementById('proctorReq');

        if (authType === 'Anugyna') {
            socket = new WebSocket('ws://localhost:8000/');
            smartLogout.style.display = "block";
        }

        if (authType === "faceAuthReq") {
            faceAuthReq.style.display = "block";
            smartLogout.style.display = "none";
        }
        else if (authType !== 'Anugyna') {

            if (authType === "NoExam") {
                smartNoExam.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }
            else if (authType === "completeFlow") {
                smartcompleteFlow.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }
            else if (authType === "scheduleDate") {
                scheduleDate.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }
            else if (authType === "NOfaceAuthReq") {
                NoFaceAuthReq.style.display = "block";
            }
            else if (authType === "bioAuth") {
                NoFaceAuthReq.style.display = "block";
            }
            else if (authType === "attemptMaxtimes") {
                faceauthmaxtimeallowed.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }
            else if (authType === "attemptMaxtimeDL") {
                smartfaceauthmaxtimeallowedDL.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }
            else if (authType === "attemptMaxtimeslot") {
                faceauthmaxtimeallowedslot.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }
            else if (authType === "alreadyCompleted") {
                alreadyCompleted.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }
            else if (authType === "expiredApplication") {
                expiredApplication.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }
            else if (authType === "photoUpload") {
                smartphotoUpload.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }
            else if (authType === "capturePhoto") {
                capturePhoto.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }

            if (authType === "maxLogins") {
                maxLogins.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }

            if (authType === "quotaFlag") {
                quotaFlag.style.display = "block";
                NoFaceAuthReq.style.display = "none";
            }

            photoUpload.style.display = "none";
            completeFlow.style.display = "none";
            NoExam.style.display = "none";
            faceauthmaxtimeallowedDL.style.display = "none";
            faceauthmaxtimeallowedslot.style.display = "none";
            faceAuthReq.style.display = "none";
            proctorReq.style.display = "none";
            smartLogout.style.display = "block";
        }

        // ============================
        // WebSocket EVENTS
        // ============================

        socket.addEventListener('open', function () {
            if (authType === 'Anugyna' && appl_no != null) {

                var reqOb = {};
                reqOb.type = "Authentication";
                reqOb.token = '1234';

                serverToken = "12345";
                reqOb.userid = appl_no;

                var request = JSON.stringify(reqOb);
                socket.send(request);

                smartDiv.style.display = "none";
                sessionStorage.setItem('authType', 'Anugyna');
            }
        });

        socket.addEventListener('message', function (event) {
            var res = JSON.parse(event.data);

            if (res.type === 'Authentication') {
                if (SHA256(serverToken) === res.token_hash) {
                    console.log({ status: "success" }, "allSet");
                } else {
                    console.log({ status: "failed" });
                }
            }
        });

        socket.addEventListener("close", function () {
            sessionStorage.clear();
            console.log("disconnected!");

            if (authType === 'Anugyna' && appl_no === '12345') {
                var pname = window.location.pathname.split('/');
                var newurl = window.location.origin + "/" + pname[1] + "/403.jsp";
                // window.location.href = newurl;
            } else {
                smartDiv.style.display = "block";
                faceAuth.style.display = "none";
                proctorReq.style.display = "none";
                smartLogout.style.display = "block";
                NoFaceAuthReq.style.display = "none";
                maxLogins.style.display = "none";
                capturePhoto.style.display = "none";
                photoUpload.style.display = "none";
                alreadyCompleted.style.display = "none";
                expiredApplication.style.display = "none";
                faceauthmaxtimeallowedslot.style.display = "none";
                faceauthmaxtimeallowedDL.style.display = "none";
                faceauthmaxtimeallowed.style.display = "none";
                scheduleDate.style.display = "none";
                completeFlow.style.display = "none";
                NoExam.style.display = "none";
                smartphotoUpload.style.display = "none";
                smartcompleteFlow.style.display = "none";
                smartNoExam.style.display = "none";
                smartfaceauthmaxtimeallowedDL.style.display = "none";
                smartfaceauthmaxtimeallowedslot.style.display = "none";
                faceAuthReq.style.display = "none";
            }
        });

        socket.addEventListener("error", function () {
            sessionStorage.clear();
            console.log("some error occurred!");
        });
    };

    // ============================
    // applStatus FUNCTION
    // ============================
    window.applStatus = function (url) {
        var appl_no = document.forms["authentication"]["llappln"].value;

        var newobj = {};
        newobj.type = 'GenerateLicence';
        newobj.userid = appl_no;
        newobj.url =
            location.origin +
            location.pathname.slice(0, window.location.pathname.lastIndexOf('/') + 1) +
            url;
    };

})();
