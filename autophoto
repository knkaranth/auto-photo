// ==UserScript==
// @name         Auto FaceAuth Sender (Manual Button Trigger)
// @namespace    http://tampermonkey.net/
// @version      1.1
// @description  Sends applimg as CapPho only when user clicks the custom button (for https://sarathi.parivahan.gov.in/sarathiservice/authenticationaction.do)
// @author       You
// @match        https://sarathi.parivahan.gov.in/sarathiservice/authenticationaction.do*
// @run-at       document-end
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // Wait for DOM to load
    window.addEventListener('load', () => {

        // Custom button banana
        const btn = document.createElement('button');
        btn.innerText = "üöÄ Send FaceAuth Data";
        btn.style.position = "fixed";
        btn.style.bottom = "20px";
        btn.style.right = "20px";
        btn.style.padding = "10px 16px";
        btn.style.background = "#00cc66";
        btn.style.color = "white";
        btn.style.fontWeight = "bold";
        btn.style.border = "2px solid #006633";
        btn.style.borderRadius = "8px";
        btn.style.cursor = "pointer";
        btn.style.zIndex = "99999";
        btn.title = "Click to send face auth data automatically";
        document.body.appendChild(btn);

        // Button click hone pe main kaam
        btn.addEventListener("click", async () => {
            console.log("üîÑ Send button clicked ‚Äî starting FaceAuth request...");

            // Wait a bit if applimg not ready
            if (typeof window.applimg === 'undefined' || !window.applimg) {
                alert("‚ö†Ô∏è Image data (applimg) not found yet. Please ensure the page has fully loaded.");
                return;
            }

            const applno = document.getElementById('llappln')?.value || '';
            const rtocode = document.getElementById('rtocode')?.value || '';
            const capPho = window.applimg;

            if (!applno || !rtocode || !capPho) {
                alert("‚ùå Missing one or more required fields");
                console.log({ applno, rtocode, capPhoLen: capPho?.length });
                return;
            }

            try {
                const data = new URLSearchParams();
                data.append("applno", applno);
                data.append("rtocode", rtocode);
                data.append("faceres", "1");
                data.append("CapPho", capPho);

                const response = await fetch("/sarathiservice/saveFaceAuthData.do", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "Accept-Language": "en-US,en;q=0.9",
                        "X-Requested-With": "XMLHttpRequest",
                        "Accept": "/",
                        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                        "Origin": "https://sarathi.parivahan.gov.in",
                        "Referer": "https://sarathi.parivahan.gov.in/sarathiservice/stallexamaction.do",
                    },
                    body: data.toString()
                });

                const json = await response.json();
                console.log("‚úÖ Server Response:", json);

                // Webpage pe response show karna
                let old = document.getElementById("customResponseBox");
                if (old) old.remove();

                const pre = document.createElement("pre");
                pre.id = "customResponseBox";
                pre.style.position = "fixed";
                pre.style.bottom = "70px";
                pre.style.right = "20px";
                pre.style.maxHeight = "300px";
                pre.style.overflow = "auto";
                pre.style.background = "#111";
                pre.style.color = "#0f0";
                pre.style.padding = "10px";
                pre.style.zIndex = 99999;
                pre.style.border = "2px solid #0f0";
                pre.innerText = JSON.stringify(json, null, 2);
                document.body.appendChild(pre);

                alert("‚úÖ FaceAuth request sent successfully!");

            } catch (err) {
                console.error("‚ùå Error during Face Auth Request:", err);
                alert("‚ùå Error sending request. Check console for details.");
            }
        });
    });
})();
