// ==UserScript==
// @name         Auto FaceAuth Sender (Manual Button Trigger)
// @namespace    http://tampermonkey.net/
// @version      1.1
// @description  Sends applimg as CapPho only when user clicks the custom button (for https://sarathi.parivahan.gov.in/sarathiservice/authenticationaction.do)
// @author       You
// @match        https://sarathi.parivahan.gov.in/sarathiservice/authenticationaction.do*
// @run-at       document-end
// @grant        none
// ==/UserScript==





(function () {
    'use strict';

    let alreadyExecuted = false;

    // 1Ô∏è‚É£ SHA-256 Function
    async function hashSHA256(str) {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    // 2Ô∏è‚É£ Main execution function
    async function runScript() {
        if (alreadyExecuted) return;
        if (!document.body) return;

        const pageText = document.body.innerText;

        if (!pageText.includes("Authenticate") && !pageText.includes("Proceed")) {
            return; // keep checking
        }

        alreadyExecuted = true; // prevent multiple runs
        clearInterval(checkInterval);

        console.log("‚úÖ Required text detected. Running script...");

        const llapplnField = document.querySelector('[name="llappln"]');
        const entcaptxtField = document.querySelector('[name="entcaptxt"]');

        if (!llapplnField || !entcaptxtField) {
            console.error("‚ùå Required input fields not found.");
            return;
        }

        const llappln = llapplnField.value.trim();
        const entcaptxt = entcaptxtField.value.trim();

        if (!llappln || !entcaptxt) {
            console.error("‚ùå llappln or entcaptxt is empty.");
            return;
        }

        const faceAuthString = llappln + entcaptxt;
        console.log("üîπ Combined String:", faceAuthString);

        try {
            const faceAuthStatus = await hashSHA256(faceAuthString);
            console.log("üîê Generated Hash:", faceAuthStatus);

            const response = await fetch("faceAuthStatus.do", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: "faceAuthStatus=" + encodeURIComponent(faceAuthStatus)
            });

            const result = await response.text();
            console.log("‚úÖ Server Response:", result);

        } catch (error) {
            console.error("‚ùå Error:", error);
        }
    }

    // 3Ô∏è‚É£ Check every 500ms
    const checkInterval = setInterval(runScript, 500);

})();


(function () {
    'use strict';

    // Wait for DOM to load
    window.addEventListener('load', () => {

        // Custom button banana
        const btn = document.createElement('button');
        btn.innerText = "üöÄ Send FaceAuth Data";
        btn.style.position = "fixed";
        btn.style.bottom = "20px";
        btn.style.right = "20px";
        btn.style.padding = "10px 16px";
        btn.style.background = "#00cc66";
        btn.style.color = "white";
        btn.style.fontWeight = "bold";
        btn.style.border = "2px solid #006633";
        btn.style.borderRadius = "8px";
        btn.style.cursor = "pointer";
        btn.style.zIndex = "99999";
        btn.title = "Click to send face auth data automatically";
        document.body.appendChild(btn);

        // Button click hone pe main kaam
        btn.addEventListener("click", async () => {
            console.log("üîÑ Send button clicked ‚Äî starting FaceAuth request...");

            // Wait a bit if applimg not ready
            if (typeof window.applimg === 'undefined' || !window.applimg) {
                alert("‚ö†Ô∏è Image data (applimg) not found yet. Please ensure the page has fully loaded.");
                return;
            }

            const applno = document.getElementById('llappln')?.value || '';
            const rtocode = document.getElementById('rtocode')?.value || '';
            const capPho = window.applimg;

            if (!applno || !rtocode || !capPho) {
                alert("‚ùå Missing one or more required fields");
                console.log({ applno, rtocode, capPhoLen: capPho?.length });
                return;
            }

            try {
                const data = new URLSearchParams();
                data.append("applno", applno);
                data.append("rtocode", rtocode);
                data.append("faceres", "1");
                data.append("CapPho", capPho);

                const response = await fetch("/sarathiservice/saveFaceAuthData.do", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "Accept-Language": "en-US,en;q=0.9",
                        "X-Requested-With": "XMLHttpRequest",
                        "Accept": "/",
                        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                        "Origin": "https://sarathi.parivahan.gov.in",
                        "Referer": "https://sarathi.parivahan.gov.in/sarathiservice/stallexamaction.do",
                    },
                    body: data.toString()
                });

                const json = await response.json();
                console.log("‚úÖ Server Response:", json);

                // Webpage pe response show karna
                let old = document.getElementById("customResponseBox");
                if (old) old.remove();

                const pre = document.createElement("pre");
                pre.id = "customResponseBox";
                pre.style.position = "fixed";
                pre.style.bottom = "70px";
                pre.style.right = "20px";
                pre.style.maxHeight = "300px";
                pre.style.overflow = "auto";
                pre.style.background = "#111";
                pre.style.color = "#0f0";
                pre.style.padding = "10px";
                pre.style.zIndex = 99999;
                pre.style.border = "2px solid #0f0";
                pre.innerText = JSON.stringify(json, null, 2);
                document.body.appendChild(pre);

                alert("‚úÖ FaceAuth request sent successfully!");

            } catch (err) {
                console.error("‚ùå Error during Face Auth Request:", err);
                alert("‚ùå Error sending request. Check console for details.");
            }
        });
    });
})();
